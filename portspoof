# Enable WSL
Write-Host "Enabling Windows Subsystem for Linux..."
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart

# Enable Virtual Machine Platform
Write-Host "Enabling Virtual Machine Platform..."
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

# Restart the computer to apply changes
Write-Host "Restarting the computer to apply changes..."
Restart-Computer

# After the restart, open a new PowerShell as administrator and continue with the following commands:

# Download and install WSL2
Write-Host "Downloading and installing WSL2..."
Invoke-WebRequest -Uri "https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi" -OutFile "wsl_update_x64.msi" -UseBasicParsing
Start-Process -Wait -FilePath "wsl_update_x64.msi" -ArgumentList "/quiet /qn /norestart"

# Set WSL2 as the default
Write-Host "Setting WSL2 as default version..."
wsl --set-default-version 2

# Download and install Ubuntu 20.04 LTS
Write-Host "Downloading and installing Ubuntu 20.04 LTS..."
Invoke-WebRequest -Uri "https://aka.ms/wslubuntu2004" -OutFile "Ubuntu2004.appx" -UseBasicParsing
Add-AppxPackage -Path "Ubuntu2004.appx"

# Launch Ubuntu to set up the environment and create a user
Write-Host "Launch Ubuntu to set up the environment and create a user."
Start-Process -FilePath "ubuntu2004.exe"

# After the environment is set up, open a new PowerShell as administrator and continue with the following commands:

# Update and upgrade packages in Ubuntu
Write-Host "Updating and upgrading packages in Ubuntu..."
wsl -e "sudo apt update && sudo apt upgrade -y"

# Install build-essential and git in Ubuntu
Write-Host "Installing build-essential and git in Ubuntu..."
wsl -e "sudo apt install -y build-essential git"

# Clone Portspoof repository in Ubuntu
Write-Host "Cloning Portspoof repository in Ubuntu..."
wsl -e "git clone https://github.com/drk1wi/portspoof.git"

# Build Portspoof in Ubuntu
Write-Host "Building Portspoof in Ubuntu..."
wsl -e "cd portspoof && ./configure && make"

# Install Portspoof in Ubuntu
Write-Host "Installing Portspoof in Ubuntu..."
wsl -e "sudo make install"

# Download Portspoof configuration file in Ubuntu
Write-Host "Downloading Portspoof configuration file in Ubuntu..."
wsl -e "sudo wget -O /usr/local/etc/portspoof.conf https://raw.githubusercontent.com/drk1wi/portspoof/master/conf/portspoof.conf"

# Generate signatures in Ubuntu
Write-Host "Generating signatures in Ubuntu..."
wsl -e "sudo /usr/local/bin/portspoof -s /usr/local/etc/portspoof_signatures -n 10000"

# Portspoof is now installed and ready to use on your Windows Server 2019 with WSL2 Ubuntu.
Write-Host "Portspoof installation is complete."
