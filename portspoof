# Check if WSL is available
$wslState = (Get-WindowsOptionalFeature -Online -FeatureName "Microsoft-Windows-Subsystem-Linux").State
$vmPlatformState = (Get-WindowsOptionalFeature -Online -FeatureName "VirtualMachinePlatform").State

if ($wslState -ne "Enabled" -or $vmPlatformState -ne "Enabled") {
    # Enable WSL
    Write-Host "Enabling Windows Subsystem for Linux..."
    dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart

    # Enable Virtual Machine Platform
    Write-Host "Enabling Virtual Machine Platform..."
    dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

    # Restart the computer to apply changes
    Write-Host "Restarting the computer to apply changes..."
    Restart-Computer
} else {
    # Download and install WSL2
    Write-Host "Downloading and installing WSL2..."
    Invoke-WebRequest -Uri "https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi" -OutFile "wsl_update_x64.msi" -UseBasicParsing
    Start-Process -Wait -FilePath "wsl_update_x64.msi" -ArgumentList "/quiet /qn /norestart"

    # Set WSL2 as the default
    Write-Host "Setting WSL2 as default version..."
    wsl --set-default-version 2

    # Download and install Ubuntu 20.04 LTS
    Write-Host "Downloading and installing Ubuntu 20.04 LTS..."
    Invoke-WebRequest -Uri "https://aka.ms/wslubuntu2004" -OutFile "Ubuntu2004.appx" -UseBasicParsing
    Add-AppxPackage -Path "Ubuntu2004.appx"

    # Launch Ubuntu to set up the environment and create a user
    Write-Host "Launch Ubuntu to set up the environment and create a user."
    Start-Process -FilePath "ubuntu2004.exe"

    # Press Enter after setting up the user in Ubuntu.
    Write-Host "Press Enter after setting up the user in Ubuntu."
    Read-Host
}
