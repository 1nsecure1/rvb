# Check if WSL is available
if (!(Get-WindowsOptionalFeature -Online -FeatureName "Microsoft-Windows-Subsystem-Linux").State -eq "Enabled") {
    # Enable WSL
    Write-Host "Enabling Windows Subsystem for Linux..."
    Install-WindowsFeature -Name Microsoft-Windows-Subsystem-Linux

    # Restart the computer to apply changes
    Write-Host "Restarting the computer to apply changes..."
    Restart-Computer
}

# Check if Ubuntu is installed
if (!(Get-AppxPackage -Name "CanonicalGroupLimited.Ubuntu*")) {
    # Download Ubuntu Appx file
    Write-Host "Downloading Ubuntu Appx file..."
    $ubuntu_url = "https://aka.ms/wslubuntu2004"
    Invoke-WebRequest -Uri $ubuntu_url -OutFile "Ubuntu.appx" -UseBasicParsing

    # Install Ubuntu
    Write-Host "Installing Ubuntu..."
    try {
        Add-AppxPackage -Path "Ubuntu.appx"
    }
    catch {
        Write-Host "Error: Failed to install Ubuntu. Please try again or install it manually."
        if (Test-Path "Ubuntu.appx") {
            Remove-Item "Ubuntu.appx"
        }
        exit
    }

    # Remove the downloaded Appx file if it exists
    if (Test-Path "Ubuntu.appx") {
        Remove-Item "Ubuntu.appx"
    }

    # Launch Ubuntu and wait for the setup to complete
    Write-Host "Launching Ubuntu for the first time to complete the setup. Please follow the prompts."
    Start-Process -FilePath "ubuntu.exe"
    Write-Host "Press Enter after Ubuntu setup is complete."
    Read-Host
}

# Update and upgrade packages
Write-Host "Updating and upgrading packages..."
wsl "sudo apt update && sudo apt upgrade -y"

# Install build-essential and git
Write-Host "Installing build-essential and git..."
wsl "sudo apt install -y build-essential git"

# Clone Portspoof repository
Write-Host "Cloning Portspoof repository..."
wsl "git clone https://github.com/drk1wi/portspoof.git"

# Change to Portspoof directory
wsl "cd portspoof"

# Build Portspoof
Write-Host "Building Portspoof..."
wsl "cd ~/portspoof && ./configure && make"

# Install Portspoof
Write-Host "Installing Portspoof..."
wsl "sudo make install"

# Download Portspoof configuration file
Write-Host "Downloading Portspoof configuration file..."
wsl "sudo wget -O /usr/local/etc/portspoof.conf https://raw.githubusercontent.com/drk1wi/portspoof/master/conf/portspoof.conf"

# Generate signatures
Write-Host "Generating signatures..."
wsl "sudo /usr/local/bin/portspoof -s /usr/local/etc/portspoof_signatures -n 10000"

# Portspoof is now installed and ready to use on your Windows Server 2019 with WSL Ubuntu.
Write-Host "Portspoof installation is complete."
